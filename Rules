#!/usr/bin/env ruby

# compile rules

compile '/rg-contacts/' do
  filter :haml
end

# This is input to gulp only
ignore '/style/'

compile '*' do
  # print item.identifier + "\n"
  if item.binary?
    # donâ€™t filter binary items
  else
    case item[:extension]
      when 'txt'
        # just copy
      when 'haml'
        filter :rfc
        filter :haml, :format => :html5
        filter :wg
        filter :rg
        filter :meeting
        filter :url
        filter :relativize_paths, :type => :html
        if /concluded/.match(item.identifier)
          layout 'historic'
        else
          layout 'default'
        end
        filter :rubypants
        filter :htmlcompressor
    end
  end
end

# route rules

route '/static/*' do
  item.identifier[7..-2]
end

route %r{^/raim-2015-papers/irtf_raim-(.+)/} do |id|
  "/raim-2015-papers/raim-2015-#{id[0]}" + '.' + item[:extension]
end

route '/rg-contacts/' do
  '/pub/rg-contacts.txt'
end

route '/htaccess/' do
  '/.htaccess'
end

route '*' do
  # print item.identifier + "\n"
  if item.binary?
    # Write item with identifier /foo/ to /foo.ext
    item.identifier.chop + '.' + item[:extension]
  else
    if item.identifier == '/'
      # if item is index page
      '/index.html'
    elsif item[:extension] == 'haml'
      # haml files become html files
      item.identifier.chop + '.html'
    else
      # keep original extension
      item.identifier.chop + '.' + item[:extension]
    end
  end
end

layout '*', :haml, :format => :html5
